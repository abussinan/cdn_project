worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Define the cache zone for L2
    # Keys are based on URL, size limit, and inactive time
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=l2_cache:10m inactive=3m max_size=1g;

    server {
        listen 80;

        # Resolve the origin_server hostname to its Docker internal IP
        # (This will be linked by Docker Compose later)
        resolver 127.0.0.11 valid=5s; # Docker's embedded DNS resolver

        location / {
            # Proxy requests to the origin server
            proxy_pass http://origin_server:80; # 'origin_server' is the service name in docker-compose

            # Disable caching for CSS files 
            if ($request_uri ~* \.css$) {
                add_header X-Cache-Status "CSS - Not Cached";
                proxy_no_cache 1;
                proxy_cache_bypass 1;
            }

            # PNG Files Cache Rules for L2: Cache after the first request, for 3 minutes 
            location ~* \.png$ {
                proxy_cache l2_cache;
                proxy_cache_valid 200 3m; # Cache 200 OK responses for 3 minutes 
                proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
                proxy_cache_min_uses 1; # Cache after the first request 
                add_header X-Cache-Status $upstream_cache_status;
            }

            # General caching settings (except for explicitly excluded types like CSS)
            proxy_cache l2_cache;
            proxy_cache_valid 200 10m; # Cache general content for 10 minutes (adjust as needed)
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
}